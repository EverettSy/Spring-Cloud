name: Docker Image CI # Actionsåç§°

on:
  push:
    branches: [ master ]
    paths:   # è¿™é‡Œæ˜¯ç”¨æ¥æŒ‡å®šå“ªä¸ªæ–‡ä»¶æ›´æ”¹ï¼Œæ‰ä¼šè§¦å‘çš„
      - 'shortcut-service/**'

jobs:

  build: # ä¸€ä¸ªåå«buildçš„ä»»åŠ¡ï¼ˆåå­—å¯ä»¥éšä¾¿èµ·ï¼‰
    runs-on: ubuntu-latest # åŸºäºæœ€æ–°ç‰ˆUbuntuç³»ç»Ÿæ‰§è¡Œä¸‹åˆ—ä»»åŠ¡
    steps:
      - uses: actions/checkout@v3 # ä½¿ç”¨actions/checkout@v3æ’ä»¶ï¼Œæ£€å‡ºä»£ç 
      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: Cache Maven packages
        uses: actions/cache@v2.1.4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build with Maven  # ç¼–è¯‘æ‰“åŒ…
        run: |
          cd shortcut-service
          mvn clean package -Dmaven.test.skip=true

      - name: Login to ACR
        uses: aliyun/acr-login@v1 # ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæœåŠ¡action ç™»å½•ACR
        with:
          login-server: https://registry.cn-hangzhou.aliyuncs.com
          username: "${{ secrets.DOCKER_USER_NAME }}"
          password: "${{ secrets.DOCKER_PASSWORD }}"

      - name: Build and push image
        env:
          IMAGE_TAG: latest # ç”¨äºæ ‡è®°å®¹å™¨ç‰ˆæœ¬å·
        run: |
          cd shortcut-service
          docker build -t registry.cn-hangzhou.aliyuncs.com/syrobin/short-service:$IMAGE_TAG .
          docker push registry.cn-hangzhou.aliyuncs.com/syrobin/short-service:$IMAGE_TAG

  deploy: # dockeréƒ¨ç½²
    needs: [ build ]
    name: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@master
        env:
          APP_NAME: "short-service"
        with:
          envs: APP_NAME
          host: ${{ secrets.HOST }} # æœåŠ¡å™¨ip
          username: ${{ secrets.HOST_USERNAME }} # æœåŠ¡å™¨ç™»å½•ç”¨æˆ·å
          password: ${{ secrets.HOST_PASSWORD }} # æœåŠ¡å™¨ç™»å½•å¯†ç 
          port: ${{ secrets.HOST_PORT }} # æœåŠ¡å™¨sshç«¯å£
          script: |
            # åœæ­¢æ—§ç‰ˆå®¹å™¨
            docker stop $(docker ps --filter ancestor=${{ secrets.DOCKER_REPOSITORY }} -q)
            # åˆ é™¤æ—§ç‰ˆå®¹å™¨
            docker rm -f $(docker ps -a --filter ancestor=${{ secrets.DOCKER_REPOSITORY }}:latest -q)
            # åˆ é™¤æ—§ç‰ˆé•œåƒ
            docker rmi -f $(docker images ${{ secrets.DOCKER_REPOSITORY }}:latest -q)
            # ç™»å½•é˜¿é‡Œäº‘é•œåƒæœåŠ¡å™¨
            docker login --username=${{ secrets.DOCKER_USER_NAME }} --password ${{ secrets.DOCKER_PASSWORD }} registry.cn-hangzhou.aliyuncs.com
            # æ‹‰å–æœ€æ–°latestç‰ˆæœ¬é•œåƒ
            docker pull ${{ secrets.DOCKER_REPOSITORY }}:latest
            # è¿è¡Œæœ€æ–°latestç‰ˆæœ¬é•œåƒ
            docker run -p 8202:8202 --name $APP_NAME \
            -e TZ="Asia/Shanghai" \
            -v /etc/localtime:/etc/localtime  \
            -v /data/app/$APP_NAME/logs:/var/logs  \
            -d ${{ secrets.DOCKER_REPOSITORY }}:latest \
            -net=mysql_default
      - run: echo "ğŸ‰----Deploy End----"