## *Raft*是一种实现分布式共识的协议。

 ####       节点可以处于 3 种状态中的 1 种状态：<u>*追随者*状态，候选状态或者领导者状态</u>，我们所有的节点都以跟随者状态开始。如果追随者没有收到领导者的消息，那么他们可以成为候选人。然后候选人向其他节点请求投票。节点将回复他们的投票。如果候选人获得大多数节点的投票，则候选人成为领导者。这个过程称为*领导人选举*。现在对系统的所有更改都通过领导者。每个更改都作为一个条目添加到节点的日志中。此日志条目当前未提交，因此不会更新节点的值。要提交条目，节点首先将其复制到跟随节点...然后领导者等待，直到大多数节点写入条目。该条目现在在领导节点上提交，节点状态为“5”。然后领导者通知追随者该条目已提交。集群现在已经就系统状态达成共识。此过程称为***日志复制***。

### 领袖选举

####        在 Raft 中有两个控制选举的超时设置。首先是选举超时。选举超时是追随者等待成为候选人的时间。选举超时随机在 150 毫秒到 300 毫秒之间。选举超时后，追随者成为候选人并开始新的*选举任期*，为自己投票...并向其他节点发送*请求投票消息。*如果接收节点在这个任期内还没有投票，那么它会投票给候选人，并且节点重置其选举超时。一旦候选人获得多数票，它就会成为领导者。领导者开始向其追随者发送*附加条目消息。*这些消息以心跳超时指定的间隔发送。追随者然后响应每个*附加条目*消息。这个选举期限将持续到一个追随者停止接收心跳并成为候选人。让我们阻止领导人并观看重新选举的发生。节点 C 现在是第 2 期的领导者。要求多数票保证每届只能选举一名领导人。如果两个节点同时成为候选人，则可能会发生分裂投票。让我们看一个分裂投票的例子......两个节点都开始同一任期的选举.........并且每个都先到达一个跟随者节点。现在每个候选人都有 2 票，并且在这个任期内不能再获得更多。节点 C 在第 5 学期获得了多数票，因此它成为领导者。

### 日志复制

#### 一旦我们选出了领导者，我们需要将系统的所有更改复制到所有节点。这是通过使用与心跳相同的*附加条目*消息来完成的。首先，客户端向领导者发送更改。更改将附加到领导者的日志中...然后在下一次心跳时将更改发送给追随者。一旦大多数追随者承认条目，就会提交条目.........并向客户端发送响应。现在让我们发送一个命令以将值增加“2”。我们的系统值现在更新为“7”。Raft 甚至可以在面对网络分区时保持一致。 让我们添加一个分区来将 A 和 B 与 C、D 和 E 分开。由于我们的分区，我们现在有两个不同的领导者。让我们添加另一个客户端并尝试更新两个领导者。一个客户端将尝试将节点 B 的值设置为“3”。节点 B 无法复制到多数，因此其日志条目保持未提交状态。另一个客户端将尝试将节点 C 的值设置为“8”。这将成功，因为它可以复制到多数。现在让我们修复网络分区。节点 B 将看到更高的选举期限并下台。节点 A 和 B 都将回滚它们未提交的条目并匹配新领导者的日志。我们的日志现在在我们的集群中是一致的。

> [Raft: Understandable Distributed Consensus](http://thesecretlivesofdata.com/raft/#)



